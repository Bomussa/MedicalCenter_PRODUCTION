# خطة المراجعة الأمنية واختبار الوظائف لمشروع AttarMedical Backend

تهدف هذه الخطة إلى ضمان أمان وسلامة وظائف مشروع AttarMedical Backend من خلال مراجعة أمنية شاملة واختبار وظيفي دقيق.

## 1. المراجعة الأمنية الشاملة

سيتم إجراء مراجعة أمنية شاملة لتحديد أي نقاط ضعف محتملة ومعالجتها قبل النشر. ستركز المراجعة على المجالات التالية:

### 1.1. تحليل الثغرات الشائعة (OWASP Top 10)

سيتم فحص التطبيق بحثًا عن الثغرات الأمنية الأكثر شيوعًا وفقًا لقائمة OWASP Top 10، بما في ذلك على سبيل المثال لا الحصر:

*   **A01: Broken Access Control**: التحقق من أن آليات التحكم في الوصول مطبقة بشكل صحيح وأن المستخدمين لا يمكنهم الوصول إلى الموارد غير المصرح لهم بها.
*   **A02: Cryptographic Failures**: التأكد من أن البيانات الحساسة (مثل كلمات المرور، أسرار 2FA) يتم تشفيرها وتخزينها بشكل آمن.
*   **A03: Injection**: التحقق من عدم وجود ثغرات حقن (مثل SQL Injection) في جميع نقاط نهاية API.
*   **A04: Insecure Design**: مراجعة التصميم العام للتطبيق لتحديد أي عيوب أمنية متأصلة.
*   **A05: Security Misconfiguration**: التحقق من أن جميع الإعدادات الأمنية (مثل متغيرات البيئة، إعدادات الخادم) تم تكوينها بشكل صحيح.
*   **A06: Vulnerable and Outdated Components**: فحص تبعيات المشروع بحثًا عن أي ثغرات أمنية معروفة باستخدام أدوات مثل `npm audit`.
*   **A07: Identification and Authentication Failures**: مراجعة آليات المصادقة (JWT، 2FA) للتأكد من أنها قوية ومقاومة لهجمات القوة الغاشمة.
*   **A08: Software and Data Integrity Failures**: التحقق من سلامة البيانات والتعليمات البرمجية، خاصة في عمليات التحديث.
*   **A09: Security Logging and Monitoring Failures**: التأكد من أن تسجيل الأخطاء والمراقبة يعملان بشكل فعال لاكتشاف وتنبيه الأنشطة المشبوهة.
*   **A10: Server-Side Request Forgery (SSRF)**: التحقق من عدم وجود ثغرات تسمح للتطبيق بإجراء طلبات غير مصرح بها إلى موارد داخلية أو خارجية.

### 1.2. مراجعة الكود البرمجي

*   **التحقق من صحة الإدخال**: التأكد من أن `express-validator` مطبق بشكل شامل وصحيح على جميع المدخلات في نقاط نهاية API.
*   **التعامل مع الأخطاء**: مراجعة آلية معالجة الأخطاء المركزية والتأكد من أنها لا تكشف معلومات حساسة للمستخدمين.
*   **إدارة الجلسات/الرموز**: التحقق من كيفية إنشاء رموز JWT وتخزينها والتحقق منها وإبطالها.
*   **التعامل مع كلمات المرور**: التأكد من أن كلمات المرور يتم تجزئتها (hashing) بشكل صحيح باستخدام `bcrypt`.
*   **تنفيذ المصادقة الثنائية (2FA)**: مراجعة منطق 2FA للتأكد من صحته وأمانه، بما في ذلك إنشاء السر والتحقق من الرمز.
*   **التحكم في الوصول**: التأكد من أن جميع نقاط النهاية المحمية تتطلب المصادقة والترخيص المناسبين (مثل `verifyToken`, `requireAdmin`).
*   **الحد من المعدل (Rate Limiting)**: التحقق من أن محددات المعدل مطبقة بشكل فعال على نقاط النهاية الحساسة (مثل تسجيل الدخول، إنشاء 2FA).

### 1.3. فحص التبعيات

*   استخدام `npm audit` لفحص جميع حزم Node.js المثبتة بحثًا عن ثغرات أمنية معروفة.
*   مراجعة إصدارات التبعيات والتأكد من أنها محدثة قدر الإمكان.

## 2. اختبار الوظائف

سيتم إجراء اختبار وظيفي شامل لجميع ميزات التطبيق، مع التركيز بشكل خاص على الميزات المضافة حديثًا.

### 2.1. اختبار نقاط نهاية المستخدمين (`/api/users`)

*   **تسجيل الدخول (`POST /api/users/login`)**:
    *   اختبار تسجيل الدخول ببيانات اعتماد صحيحة وغير صحيحة.
    *   اختبار تسجيل الدخول لمستخدمين غير نشطين.
    *   اختبار تسجيل الدخول مع 2FA ممكّن (رمز صحيح وغير صحيح).
    *   اختبار الحد من المعدل على نقطة نهاية تسجيل الدخول.
*   **الحصول على جميع المستخدمين (`GET /api/users`)**:
    *   اختبار الوصول كمسؤول ومستخدم عادي (يجب أن يفشل للمستخدم العادي).
    *   اختبار الترحيل (Pagination) باستخدام معلمات `page` و `limit`.
*   **إنشاء مستخدم جديد (`POST /api/users`)**:
    *   اختبار إنشاء مستخدم ببيانات صحيحة وغير صحيحة (مثل دور غير صالح، اسم مستخدم موجود).
    *   اختبار الوصول كمسؤول ومستخدم عادي.
*   **تحديث حالة المستخدم (`PATCH /api/users/:id/status`)**:
    *   اختبار تنشيط/تعطيل المستخدم ببيانات صحيحة وغير صحيحة.
    *   اختبار الوصول كمسؤول ومستخدم عادي.
*   **حذف مستخدم (`DELETE /api/users/:id`)**:
    *   اختبار حذف المستخدم كمسؤول خارق ومسؤول عادي (يجب أن يفشل للمسؤول العادي).
    *   اختبار حذف مستخدم غير موجود.
*   **إنشاء سر 2FA (`POST /api/users/2fa/generate`)**:
    *   اختبار إنشاء سر 2FA لمستخدم مصادق عليه.
    *   اختبار الحد من المعدل على نقطة نهاية إنشاء 2FA.
*   **تمكين 2FA (`POST /api/users/2fa/enable`)**:
    *   اختبار تمكين 2FA برمز صحيح وغير صحيح.
    *   اختبار محاولة تمكين 2FA بدون إعداد سر مسبقًا.
*   **تعطيل 2FA (`POST /api/users/2fa/disable`)**:
    *   اختبار تعطيل 2FA برمز صحيح وغير صحيح.
    *   اختبار محاولة تعطيل 2FA بدون تمكينه مسبقًا.

### 2.2. اختبار نقاط نهاية العيادات (`/api/clinics`)

*   **الحصول على جميع العيادات (`GET /api/clinics`)**:
    *   اختبار الترحيل (Pagination) باستخدام معلمات `page` و `limit`.
*   **الحصول على عيادة حسب المعرف (`GET /api/clinics/:id`)**:
    *   اختبار الحصول على عيادة موجودة وغير موجودة.
*   **إنشاء عيادة جديدة (`POST /api/clinics`)**:
    *   اختبار إنشاء عيادة ببيانات صحيحة وغير صحيحة.
    *   اختبار الوصول كمسؤول ومستخدم عادي.
*   **تحديث عيادة (`PUT /api/clinics/:id`)**:
    *   اختبار تحديث عيادة ببيانات صحيحة وغير صحيحة.
    *   اختبار الوصول كمسؤول ومستخدم عادي.
*   **حذف عيادة (`DELETE /api/clinics/:id`)**:
    *   اختبار حذف عيادة موجودة وغير موجودة.
    *   اختبار الوصول كمسؤول ومستخدم عادي.

### 2.3. اختبار نقاط نهاية الاختبارات (`/api/exams`)

*   **الحصول على جميع الاختبارات (`GET /api/exams`)**:
    *   اختبار الترحيل (Pagination) باستخدام معلمات `page` و `limit`.
*   **الحصول على اختبار حسب المعرف (`GET /api/exams/:id`)**:
    *   اختبار الحصول على اختبار موجود وغير موجود.
*   **إنشاء اختبار جديد (`POST /api/exams`)**:
    *   اختبار إنشاء اختبار ببيانات صحيحة وغير صحيحة (مثل جنس غير صالح، `clinicCount` غير متناسق مع `clinics`).
    *   اختبار الوصول كمسؤول ومستخدم عادي.
*   **تحديث اختبار (`PUT /api/exams/:id`)**:
    *   اختبار تحديث اختبار ببيانات صحيحة وغير صحيحة.
    *   اختبار تحديث `clinicCount` تلقائيًا عند تعديل مصفوفة `clinics`.
    *   اختبار الوصول كمسؤول ومستخدم عادي.
*   **حذف اختبار (`DELETE /api/exams/:id`)**:
    *   اختبار حذف اختبار موجود وغير موجود.
    *   اختبار الوصول كمسؤول ومستخدم عادي.
*   **الحصول على اختبارات حسب الجنس (`GET /api/exams/gender/:gender`)**:
    *   اختبار التصفية حسب الجنس ببيانات صحيحة وغير صحيحة.

### 2.4. اختبار توثيق Swagger UI

*   الوصول إلى `/api-docs` والتأكد من عرض التوثيق بشكل صحيح.
*   اختبار نقاط النهاية المختلفة مباشرة من واجهة Swagger UI للتأكد من أن الطلبات والاستجابات تتطابق مع التوثيق.

## 3. أدوات الاختبار

*   **Postman/Insomnia**: لاختبار نقاط نهاية API يدويًا.
*   **Jest/Supertest**: للاختبارات الآلية (إذا كانت موجودة أو سيتم إضافتها).
*   **npm audit**: لفحص تبعيات المشروع.

## 4. تقرير المراجعة والنتائج

بعد الانتهاء من المراجعة الأمنية واختبار الوظائف، سيتم إعداد تقرير مفصل يلخص النتائج، بما في ذلك:

*   الثغرات الأمنية المكتشفة وتوصيات المعالجة.
*   نتائج الاختبارات الوظيفية وأي أخطاء تم العثور عليها.
*   تقييم عام لجودة الكود والأمان.

**ملاحظة**: هذه الخطة هي إطار عمل. قد تتطلب بعض الخطوات أدوات أو تقنيات إضافية حسب تعقيد الثغرات أو الأخطاء المكتشفة.
